/*
 * jQuery UI Nested Sortable
 * v 2.0 / 29 oct 2012
 * http://mjsarfatti.com/sandbox/nestedSortable
 *
 * Depends on:
 *	 jquery.ui.sortable.js 1.10+
 *
 * Copyright (c) 2010-2013 Manuele J Sarfatti
 * Licensed under the MIT License
 * http://www.opensource.org/licenses/mit-license.php
 */
(function(a){function b(a,b,c){return a>b&&a<b+c}a.widget("mjs.nestedSortable",a.extend({},a.ui.sortable.prototype,{options:{doNotClear:!1,expandOnHover:700,isAllowed:function(a,b,c){return!0},isTree:!1,listType:"ol",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,startCollapsed:!1,tabSize:20,branchClass:"mjs-nestedSortable-branch",collapsedClass:"mjs-nestedSortable-collapsed",disableNestingClass:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",expandedClass:"mjs-nestedSortable-expanded",hoveringClass:"mjs-nestedSortable-hovering",leafClass:"mjs-nestedSortable-leaf"},_create:function(){this.element.data("ui-sortable",this.element.data("mjs-nestedSortable"));if(!this.element.is(this.options.listType))throw new Error("nestedSortable: Please check that the listType option is set to your actual list type");this.options.isTree&&this.options.expandOnHover&&(this.options.tolerance="intersect"),a.ui.sortable.prototype._create.apply(this,arguments);if(this.options.isTree){var b=this;a(this.items).each(function(){var a=this.item;a.children(b.options.listType).length?(a.addClass(b.options.branchClass),b.options.startCollapsed?a.addClass(b.options.collapsedClass):a.addClass(b.options.expandedClass)):a.addClass(b.options.leafClass)})}},_destroy:function(){return this.element.removeData("mjs-nestedSortable").removeData("ui-sortable"),a.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(b){var c,d,e,f,g=this.options,h=!1;this.position=this._generatePosition(b),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-b.pageY<g.scrollSensitivity?this.scrollParent[0].scrollTop=h=this.scrollParent[0].scrollTop+g.scrollSpeed:b.pageY-this.overflowOffset.top<g.scrollSensitivity&&(this.scrollParent[0].scrollTop=h=this.scrollParent[0].scrollTop-g.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-b.pageX<g.scrollSensitivity?this.scrollParent[0].scrollLeft=h=this.scrollParent[0].scrollLeft+g.scrollSpeed:b.pageX-this.overflowOffset.left<g.scrollSensitivity&&(this.scrollParent[0].scrollLeft=h=this.scrollParent[0].scrollLeft-g.scrollSpeed)):(b.pageY-a(document).scrollTop()<g.scrollSensitivity?h=a(document).scrollTop(a(document).scrollTop()-g.scrollSpeed):a(window).height()-(b.pageY-a(document).scrollTop())<g.scrollSensitivity&&(h=a(document).scrollTop(a(document).scrollTop()+g.scrollSpeed)),b.pageX-a(document).scrollLeft()<g.scrollSensitivity?h=a(document).scrollLeft(a(document).scrollLeft()-g.scrollSpeed):a(window).width()-(b.pageX-a(document).scrollLeft())<g.scrollSensitivity&&(h=a(document).scrollLeft(a(document).scrollLeft()+g.scrollSpeed))),h!==!1&&a.ui.ddmanager&&!g.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b)),this.positionAbs=this._convertPositionTo("absolute");var i=this.placeholder.offset().top;if(!this.options.axis||this.options.axis!=="y")this.helper[0].style.left=this.position.left+"px";if(!this.options.axis||this.options.axis!=="x")this.helper[0].style.top=this.position.top+"px";this.hovering=this.hovering?this.hovering:null,this.mouseentered=this.mouseentered?this.mouseentered:!1;var j=this.placeholder[0].parentNode.parentNode&&a(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?a(this.placeholder[0].parentNode.parentNode):null,k=this._getLevel(this.placeholder),l=this._getChildLevels(this.helper),m=document.createElement(g.listType);for(c=this.items.length-1;c>=0;c--){d=this.items[c],e=d.item[0],f=this._intersectsWithPointer(d);if(!f)continue;if(d.instance!==this.currentContainer)continue;if(e!==this.currentItem[0]&&this.placeholder[f===1?"next":"prev"]()[0]!==e&&!a.contains(this.placeholder[0],e)&&(this.options.type==="semi-dynamic"?!a.contains(this.element[0],e):!0)){this.mouseentered||(a(e).mouseenter(),this.mouseentered=!0);if(g.isTree&&a(e).hasClass(g.collapsedClass)&&g.expandOnHover&&!this.hovering){a(e).addClass(g.hoveringClass);var n=this;this.hovering=window.setTimeout(function(){a(e).removeClass(g.collapsedClass).addClass(g.expandedClass),n.refreshPositions(),n._trigger("expand",b,n._uiHash())},g.expandOnHover)}this.direction=f==1?"down":"up";if(this.options.tolerance!="pointer"&&!this._intersectsWithSides(d))break;a(e).mouseleave(),this.mouseentered=!1,a(e).removeClass(g.hoveringClass),this.hovering&&window.clearTimeout(this.hovering),this.hovering=null;if(!g.protectRoot||this.currentItem[0].parentNode==this.element[0]&&e.parentNode!=this.element[0])g.protectRoot||this._rearrange(b,d);else if(this.currentItem[0].parentNode!=this.element[0]&&e.parentNode==this.element[0]){a(e).children(g.listType).length||(e.appendChild(m),g.isTree&&a(e).removeClass(g.leafClass).addClass(g.branchClass+" "+g.expandedClass));var o=this.direction==="down"?a(e).prev().children(g.listType):a(e).children(g.listType);o[0]!==undefined&&this._rearrange(b,null,o)}else this._rearrange(b,d);this._clearEmpty(e),this._trigger("change",b,this._uiHash());break}}var p=this.placeholder[0].previousSibling?a(this.placeholder[0].previousSibling):null;if(p!=null)while(p[0].nodeName.toLowerCase()!="li"||p[0]==this.currentItem[0]||p[0]==this.helper[0]){if(!p[0].previousSibling){p=null;break}p=a(p[0].previousSibling)}var q=this.placeholder[0].nextSibling?a(this.placeholder[0].nextSibling):null;if(q!=null)while(q[0].nodeName.toLowerCase()!="li"||q[0]==this.currentItem[0]||q[0]==this.helper[0]){if(!q[0].nextSibling){q=null;break}q=a(q[0].nextSibling)}return this.beyondMaxLevels=0,j!=null&&q==null&&(!g.protectRoot||j[0].parentNode!=this.element[0])&&(g.rtl&&this.positionAbs.left+this.helper.outerWidth()>j.offset().left+j.outerWidth()||!g.rtl&&this.positionAbs.left<j.offset().left)?(j.after(this.placeholder[0]),g.isTree&&j.children(g.listItem).children("li:visible:not(.ui-sortable-helper)").length<1&&j.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass),this._clearEmpty(j[0]),this._trigger("change",b,this._uiHash())):p!=null&&!p.hasClass(g.disableNestingClass)&&(p.children(g.listType).length&&p.children(g.listType).is(":visible")||!p.children(g.listType).length)&&(!g.protectRoot||this.currentItem[0].parentNode!=this.element[0])&&(g.rtl&&this.positionAbs.left+this.helper.outerWidth()<p.offset().left+p.outerWidth()-g.tabSize||!g.rtl&&this.positionAbs.left>p.offset().left+g.tabSize)?(this._isAllowed(p,k,k+l+1),p.children(g.listType).length||(p[0].appendChild(m),g.isTree&&p.removeClass(g.leafClass).addClass(g.branchClass+" "+g.expandedClass)),i&&i<=p.offset().top?p.children(g.listType).prepend(this.placeholder):p.children(g.listType)[0].appendChild(this.placeholder[0]),this._trigger("change",b,this._uiHash())):this._isAllowed(j,k,k+l),this._contactContainers(b),a.ui.ddmanager&&a.ui.ddmanager.drag(this,b),this._trigger("sort",b,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(b,c){this.beyondMaxLevels&&(this.placeholder.removeClass(this.options.errorClass),this.domPosition.prev?a(this.domPosition.prev).after(this.placeholder):a(this.domPosition.parent).prepend(this.placeholder),this._trigger("revert",b,this._uiHash())),a("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass),this.mouseentered=!1,this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,a.ui.sortable.prototype._mouseStop.apply(this,arguments)},_intersectsWithSides:function(a){var c=this.options.isTree?.8:.5,d=b(this.positionAbs.top+this.offset.click.top,a.top+a.height*c,a.height),e=b(this.positionAbs.top+this.offset.click.top,a.top-a.height*c,a.height),f=b(this.positionAbs.left+this.offset.click.left,a.left+a.width/2,a.width),g=this._getDragVerticalDirection(),h=this._getDragHorizontalDirection();return this.floating&&h?h=="right"&&f||h=="left"&&!f:g&&(g=="down"&&d||g=="up"&&e)},_contactContainers:function(b){if(this.options.protectRoot&&this.currentItem[0].parentNode==this.element[0])return;a.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(b,c){a.ui.sortable.prototype._clear.apply(this,arguments);for(var d=this.items.length-1;d>=0;d--){var e=this.items[d].item[0];this._clearEmpty(e)}},serialize:function(b){var c=a.extend({},this.options,b),d=this._getItemsAsjQuery(c&&c.connected),e=[];return a(d).each(function(){var b=(a(c.item||this).attr(c.attribute||"id")||"").match(c.expression||/(.+)[-=_](.+)/),d=(a(c.item||this).parent(c.listType).parent(c.items).attr(c.attribute||"id")||"").match(c.expression||/(.+)[-=_](.+)/);b&&e.push((c.key||b[1])+"["+(c.key&&c.expression?b[1]:b[2])+"]"+"="+(d?c.key&&c.expression?d[1]:d[2]:c.rootID))}),!e.length&&c.key&&e.push(c.key+"="),e.join("&")},toHierarchy:function(b){function f(b){var d=(a(b).attr(c.attribute||"id")||"").match(c.expression||/(.+)[-=_](.+)/);if(d){var e={id:d[2]};return a(b).children(c.listType).children(c.items).length>0&&(e.children=[],a(b).children(c.listType).children(c.items).each(function(){var a=f(this);e.children.push(a)})),e}}var c=a.extend({},this.options,b),d=c.startDepthCount||0,e=[];return a(this.element).children(c.items).each(function(){var a=f(this);e.push(a)}),e},toArray:function(b){function g(b,f,h){var i=h+1,j,k;a(b).children(c.listType).children(c.items).length>0&&(f++,a(b).children(c.listType).children(c.items).each(function(){i=g(a(this),f,i)}),f--),j=a(b).attr(c.attribute||"id").match(c.expression||/(.+)[-=_](.+)/);if(f===d+1)k=c.rootID;else{var l=a(b).parent(c.listType).parent(c.items).attr(c.attribute||"id").match(c.expression||/(.+)[-=_](.+)/);k=l[2]}return j&&e.push({item_id:j[2],parent_id:k,depth:f,left:h,right:i}),h=i+1,h}var c=a.extend({},this.options,b),d=c.startDepthCount||0,e=[],f=1;return c.excludeRoot||(e.push({item_id:c.rootID,parent_id:null,depth:d,left:f,right:(a(c.items,this.element).length+1)*2}),f++),a(this.element).children(c.items).each(function(){f=g(this,d+1,f)}),e=e.sort(function(a,b){return a.left-b.left}),e},_clearEmpty:function(b){var c=this.options,d=a(b).children(c.listType);d.length&&!d.children().length&&!c.doNotClear?(c.isTree&&a(b).removeClass(c.branchClass+" "+c.expandedClass).addClass(c.leafClass),d.remove()):c.isTree&&d.length&&d.children().length&&d.is(":visible")?a(b).removeClass(c.leafClass).addClass(c.branchClass+" "+c.expandedClass):c.isTree&&d.length&&d.children().length&&!d.is(":visible")&&a(b).removeClass(c.leafClass).addClass(c.branchClass+" "+c.collapsedClass)},_getLevel:function(a){var b=1;if(this.options.listType){var c=a.closest(this.options.listType);while(c&&c.length>0&&!c.is(".ui-sortable"))b++,c=c.parent().closest(this.options.listType)}return b},_getChildLevels:function(b,c){var d=this,e=this.options,f=0;return c=c||0,a(b).children(e.listType).children(e.items).each(function(a,b){f=Math.max(d._getChildLevels(b,c+1),f)}),c?f+1:f},_isAllowed:function(a,b,c){var d=this.options,e=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels");d.isAllowed(this.placeholder,a,this.currentItem)?e<c&&e!=0?(this.placeholder.addClass(d.errorClass),this.beyondMaxLevels=c-e):(this.placeholder.removeClass(d.errorClass),this.beyondMaxLevels=0):(this.placeholder.addClass(d.errorClass),e<c&&e!=0?this.beyondMaxLevels=c-e:this.beyondMaxLevels=1)}})),a.mjs.nestedSortable.prototype.options=a.extend({},a.ui.sortable.prototype.options,a.mjs.nestedSortable.prototype.options)})(jQuery),function(){window.ActiveAdminSortableEvent=function(){var a;return a={},{add:function(b,c){return a.hasOwnProperty(b)||(a[b]=[]),a[b].push(c)},trigger:function(b,c){var d,e,f,g,h,i;if(a.hasOwnProperty(b)){h=a[b],i=[];for(f=0,g=h.length;f<g;f++){d=h[f];try{i.push(d.call(null,c))}catch(j){e=j,console&&console.error?i.push(console.error(e)):i.push(void 0)}}return i}}}}(),$(function(){return $(".disclose").bind("click",function(a){return $(this).closest("li").toggleClass("mjs-nestedSortable-collapsed").toggleClass("mjs-nestedSortable-expanded")}),$("[data-sortable-type=plain]").each(function(){var a;return a=$(this),a.sortable({revert:250,update:function(){return a.sortable("disable"),$.ajax({url:a.data("sortable-url"),type:"post",data:a.sortable("serialize")}).always(function(){return a.sortable("enable"),ActiveAdminSortableEvent.trigger("ajaxAlways")}).done(function(){return ActiveAdminSortableEvent.trigger("ajaxDone")}).fail(function(){return ActiveAdminSortableEvent.trigger("ajaxFail")})}}).disableSelection()}),$(".index_as_sortable [data-sortable-type]").each(function(){var a,b,c;return a=$(this),a.data("sortable-type")==="tree"?(b=a.data("max-levels"),c=20):(b=1,c=99999),a.nestedSortable({forcePlaceholderSize:!0,forceHelperSizeType:!0,errorClass:"cantdoit",disableNesting:"cantdoit",handle:"> .item",listType:"ol",items:"li",opacity:.6,placeholder:"placeholder",revert:250,maxLevels:b,tabSize:c,protectRoot:a.data("protect-root"),tolerance:"pointer",toleranceElement:"> div",isTree:!0,startCollapsed:a.data("start-collapsed"),update:function(){return a.nestedSortable("disable"),$.ajax({url:a.data("sortable-url"),type:"post",data:a.nestedSortable("serialize")}).always(function(){return a.find(".item").each(function(a){return a%2?$(this).removeClass("odd").addClass("even"):$(this).removeClass("even").addClass("odd")}),a.nestedSortable("enable"),ActiveAdminSortableEvent.trigger("ajaxAlways")}).done(function(){return ActiveAdminSortableEvent.trigger("ajaxDone")}).fail(function(){return ActiveAdminSortableEvent.trigger("ajaxFail")})}})})})}.call(this);